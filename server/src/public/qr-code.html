<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta
			name="viewport"
			content="width=device-width, initial-scale=1.0"
		/>
		<link
			rel="stylesheet"
			href="./styles/mvp.css"
		/>
		<title>Whatsapp Alerts Bot | QR</title>
	</head>
	<body>
		<main>
			<section id="qr-container-section">
				<header id="qr-container">
					<h2>QR CODE</h2>
				</header>
			</section>
		</main>
		<footer id="footer">
			<hr />
			<p>
				Check creator profile
				<a
					href="https://github.com/pablolgamarra"
					target="_blank"
					>Pablo Gamarra</a
				>
			</p>
		</footer>
		<script>
            let lastCount = 0

			async function loadQRCode() {
				try {
					const res = await fetch('/api/qr');
					const data = await res.json();
					const qrContainer = document.getElementById('qr-container');

					if (!data.qr || data.qr === undefined || data.qr.length < 0) {
                        qrContainer.innerHTML = `<h2>There is no QR Code generated yet.</h2>
                        <p>Waiting...</p>`;
					} else {
                        qrContainer.innerHTML = `
                            <img src="https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(
                            data.qr,
                        )}" alt="Login QR Code" />
                        `;
					}
				} catch (err) {
					document.getElementById('qr-container').innerHTML = '<p>Error loading QR. Try re-loading page</p>';
				}
			}
            
            async function checkQRCount (){
                const data = await fetch('/api/qr-count').then((res) => res.json());
                const qrContainer = document.getElementById('qr-container');

                try{
                    if (data.count !== lastCount) {
                        lastCount = data.count;
                        qrContainer.innerHTML = `<h2>New QR Generated!.</h2>
                            <p>Reloading...</p>`;
                        loadQRCode();
                    }
                } catch (err) {
                    console.error("Error checking QR Count:", err);
                }
            }

            loadQRCode();
            setInterval(checkQRCount, 10000)
		</script>
	</body>
</html>
